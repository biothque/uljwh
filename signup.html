<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créer un compte – Thoth</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/backendless"></script>
</head>
<body>

  <div class="overlay">
    <!-- Bouton retour -->
    <a href="index.html" class="btn-back" onclick="vibrateButton()">
      &#8592; Retour
    </a>
    <h1>Créer un compte</h1>
    <p>Rejoignez-nous pour explorer la ligne temporelle</p>

    <form id="signupForm">
      <input type="email" name="email" placeholder="exemple@domaine.com" required>
      <input type="text" name="nom" placeholder="BADESI Christian" required>
      <input type="text" name="institut" placeholder="Université de Kongo" required>
      <input type="text" name="option" placeholder="Informatique / Médecine" required>

      <!-- Champ Genre -->
      <label for="genre">Genre :</label>
      <select name="genre" id="genre" required>
        <option value="">-- Sélectionnez --</option>
        <option value="Homme">Homme</option>
        <option value="Femme">Femme</option>
      </select>

      <!-- Champ Abonnement -->
      <label for="abonnement">Type d'abonnement :</label>
      <select name="abonnement" id="abonnement" required>
        <option value="">-- Sélectionnez --</option>
        <option value="Individuel">Individuel</option>
        <option value="Collectif">Collectif</option>
        <option value="Institutionnel">Institutionnel</option>
      </select>

      <label for="montant">Prix d'un abonnement individuel :</label>
      <select name="montant" id="montant" required>
        <option value="">-- Sélectionnez --</option>
        <option value="Hebdomadaire">Hebdomadaire = 2$</option>
        <option value="Mensuel">Mensuel = 5$</option>
        <option value="Negociable">Entreprise/Institution</option>
      </select>

      <button type="submit" class="btn-connexion" onclick="vibrateButton()">S'inscrire</button>
    </form>

    <!-- Messages -->
    <p id="successMessage">Un email de confirmation a été envoyé à votre adresse. Veuillez vérifier votre boîte de réception pour obtenir le matricule.</p>
    <p id="errorMessage"></p>
  </div>
  
  <script>
    // Backendless config
    const APP_ID = "75F9B527-FE0B-4C7E-B2F4-1AD71EE054A0";
    const API_KEY = "60E69D44-7601-447C-B228-6E26EE396C20";
    const TABLE  = "membres";

    Backendless.initApp(APP_ID, API_KEY);

    // Vibration
    function vibrateButton() {
      if (navigator.vibrate) navigator.vibrate(100);
    }

    const form = document.getElementById('signupForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const email = form.email.value.trim();
      const nom = form.nom.value.trim();
      const institut = form.institut.value.trim();
      const option = form.option.value.trim();
      const genre = form.genre.value.trim();
      const abonnement = form.abonnement.value.trim();
      const montant = form.montant.value.trim();

      try {
        const query = Backendless.Data.QueryBuilder.create().setWhereClause(`email = '${email}'`);
        const existing = await Backendless.Data.of(TABLE).find(query);

        if (existing.length > 0) {
          errorMessage.style.display = "block";
          errorMessage.textContent = "Ce compte existe déjà !";
          return;
        }

        const membre = { email, nom, institut, option, genre, abonnement, montant };
        await Backendless.Data.of(TABLE).save(membre);

        successMessage.style.display = "block";
        errorMessage.style.display = "none";
        form.reset();

        setTimeout(() => {
          window.location.replace("login.html");
        }, 8000);

      } catch (error) {
        console.error(error);
        errorMessage.style.display = "block";
        errorMessage.textContent = "Une erreur est survenue, réessayez.";
      }
    });

    // Empêcher retour arrière
    history.pushState(null, null, location.href);
    window.onpopstate = function () { history.go(1); };
  </script>

</body>
</html>
